# تنظیمات پس از ادغام با `main`: APIها و متغیرهای محیطی

پس از اینکه تغییرات خود را در یک برنچ ایجاد کرده، `push` کرده و سپس با برنچ `main` ادغام (merge) می‌کنید، سیستم CI/CD به طور خودکار فعال می‌شود. با این حال، برای اطمینان از عملکرد صحیح و امن سیستم، به ویژه در مورد APIها و متغیرهای محیطی، چندین تنظیم و کنترل وجود دارد که باید به آن‌ها توجه کنید. راهنماهای کاربری، نگهداری و توسعه که قبلاً ارائه شد، به این موارد اشاره کرده‌اند، اما در اینجا یک خلاصه از مهمترین نکات ارائه می‌شود:

## 1. مدیریت Secrets (کلیدهای API و اطلاعات حساس)

مهمترین تنظیمات مربوط به APIها، مدیریت ایمن کلیدهای API و سایر اطلاعات حساس است. این اطلاعات هرگز نباید مستقیماً در کد یا فایل‌های پیکربندی داخل مخزن Git ذخیره شوند.

*   **GitHub Secrets**: تمامی کلیدهای API (مانند `RENDER_API_KEY` برای Render.com) و سایر اطلاعات حساس باید به عنوان **GitHub Secrets** در مخزن شما ذخیره شوند. این کار از طریق رابط کاربری GitHub انجام می‌شود:
    1.  به مخزن خود در GitHub بروید.
    2.  روی `Settings` کلیک کنید.
    3.  در نوار کناری سمت چپ، `Secrets and variables` و سپس `Actions` را انتخاب کنید.
    4.  روی `New repository secret` کلیک کنید و نام Secret (مثلاً `RENDER_API_KEY`) و مقدار آن را وارد کنید.
    *   **چرا این مهم است؟** GitHub Secrets مقادیر را رمزنگاری کرده و فقط در زمان اجرای Workflow در دسترس قرار می‌دهد. این امر از نشت اطلاعات حساس جلوگیری می‌کند.

*   **متغیرهای محیطی خاص محیط (Environment Secrets)**: اگر یک کلید API یا Secret خاص فقط برای یک محیط استقرار (مانند `Staging` یا `Production`) معتبر است، بهتر است آن را به عنوان یک Secret در **محیط GitHub Actions** تعریف کنید:
    1.  به مخزن خود در GitHub بروید.
    2.  روی `Settings` کلیک کنید.
    3.  در نوار کناری سمت چپ، `Environments` را انتخاب کنید.
    4.  روی محیط مورد نظر (مثلاً `Staging` یا `Production`) کلیک کنید.
    5.  در بخش `Environment secrets`، Secret مورد نظر را اضافه کنید.
    *   **چرا این مهم است؟** این کار تضمین می‌کند که Secrets پروداکشن هرگز به طور تصادفی در محیط تست یا استیجینگ در دسترس قرار نگیرند.

## 2. پیکربندی `config/projects.yaml`

فایل `config/projects.yaml` قلب پیکربندی پروژه‌های شماست و باید به درستی تنظیم شود:

*   **`render_service_id`**: برای هر پروژه و هر محیط استقرار (Test, Staging, Production)، باید `render_service_id` صحیح سرویس مربوطه در Render.com را وارد کنید. این شناسه‌ها به `mamos_runner.py` می‌گویند که کدام سرویس را در Render.com برای استقرار هدف قرار دهد.
    *   **چرا این مهم است؟** اگر این شناسه‌ها اشتباه باشند، استقرار در سرویس اشتباهی انجام می‌شود یا با خطا مواجه خواهد شد.

## 3. بررسی GitHub Actions Workflows

فایل‌های Workflow در پوشه `.github/workflows/` نحوه اجرای CI/CD را تعریف می‌کنند:

*   **مجوزها (`permissions`)**: اطمینان حاصل کنید که هر Workflow دارای حداقل مجوزهای لازم برای انجام وظایف خود است. این کار با بلاک `permissions` در فایل `.yml` انجام می‌شود. برای مثال، اگر Workflow نیاز به `write` کردن گزارش‌ها به مخزن دارد، باید `contents: write` را داشته باشد.
    *   **چرا این مهم است؟** اعطای مجوزهای بیش از حد می‌تواند یک ریسک امنیتی باشد.

*   **تایید دستی (Manual Approvals)**: برای محیط‌های حساس مانند `Staging` و `Production`، باید تایید دستی را در Workflowهای مربوطه فعال کرده باشید. این کار در تنظیمات محیط GitHub Actions انجام می‌شود و در فایل Workflow نیز باید محیط مشخص شده باشد.
    *   **چرا این مهم است؟** این یک لایه امنیتی و کنترلی حیاتی است که از استقرارهای ناخواسته یا بدون بازبینی جلوگیری می‌کند.

*   **متغیرهای محیطی در Workflow**: اگر Workflow شما نیاز به متغیرهای محیطی خاصی دارد که از Secrets تامین نمی‌شوند (مثلاً یک پرچم `DEBUG=true` برای محیط توسعه)، باید آن‌ها را در بلاک `env` در Workflow تعریف کنید.

## 4. پلتفرم استقرار (Render.com)

*   **ایجاد سرویس‌ها**: قبل از اینکه `mamos_runner.py` بتواند در Render.com استقرار یابد، باید سرویس‌های مربوطه (مثلاً `backend-staging`, `backend-production`) را به صورت دستی در Render.com ایجاد کرده باشید و `render_service_id` آن‌ها را در `config/projects.yaml` وارد کنید.
*   **تنظیمات محیطی در Render.com**: علاوه بر GitHub Secrets، ممکن است نیاز باشد برخی متغیرهای محیطی را مستقیماً در تنظیمات سرویس‌های Render.com خود تعریف کنید. این متغیرها معمولاً برای پیکربندی‌های خاص زمان اجرا (Runtime) سرویس شما هستند که توسط Render.com مدیریت می‌شوند.

## خلاصه

پس از ادغام کد با `main`، تمرکز اصلی بر روی **پیکربندی‌های خارج از کدبیس** است که شامل مدیریت **GitHub Secrets** و **Environment Secrets** برای کلیدهای API و اطلاعات حساس، **تنظیمات `render_service_id` در `config/projects.yaml`**، و **بررسی مجوزها و تاییدهای دستی در GitHub Actions Workflows** می‌شود. اطمینان از صحت این تنظیمات، کلید یکپارچه‌سازی مداوم و استقرار مداوم امن و موفق است.
