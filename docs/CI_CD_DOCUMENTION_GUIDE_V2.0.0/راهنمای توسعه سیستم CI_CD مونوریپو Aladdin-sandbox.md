# راهنمای توسعه سیستم CI/CD مونوریپو Aladdin-sandbox

## مقدمه
این سند راهنمای توسعه برای سیستم یکپارچه‌سازی مداوم/استقرار مداوم (CI/CD) پیاده‌سازی شده در مونوریپو `aladdin-sandbox` است. هدف این راهنما، ارائه اطلاعات لازم برای توسعه‌دهندگان و مهندسان DevOps است تا بتوانند سیستم CI/CD را گسترش دهند، تغییر دهند و با نیازهای جدید پروژه سازگار کنند.

## 1. معماری سیستم CI/CD

سیستم CI/CD ما بر پایه دو جزء اصلی بنا شده است:

*   **`mamos_runner.py`**: یک اسکریپت پایتون که هسته منطق CI/CD را تشکیل می‌دهد. این اسکریپت مسئول خواندن پیکربندی پروژه، اجرای دستورات بیلد و تست، و تعامل با APIهای استقرار (مانند Render.com) است.
*   **GitHub Actions Workflows**: فایل‌های YAML که نحوه اجرای `mamos_runner.py` را در محیط GitHub Actions تعریف می‌کنند. این Workflowها تریگرها، محیط‌ها، Secrets و مراحل اجرای CI/CD را مدیریت می‌کنند.

## 2. فایل‌های کلیدی برای توسعه

*   **`infra/ci-cd/mamos_runner.py`**: 
    *   **هدف**: اجرای مراحل بیلد، تست و استقرار برای یک پروژه مشخص.
    *   **تغییرات رایج**: افزودن پشتیبانی از انواع جدید پروژه، بهبود منطق گزارش‌دهی، اضافه کردن مراحل جدید CI/CD (مانند اسکن امنیتی)، یا تغییر نحوه تعامل با پلتفرم‌های استقرار.
*   **`config/projects.yaml`**: 
    *   **هدف**: تعریف پروژه‌ها، مسیر آن‌ها، دستورات بیلد و تست، و پیکربندی استقرار برای هر محیط.
    *   **تغییرات رایج**: افزودن پروژه جدید، به‌روزرسانی دستورات بیلد/تست برای پروژه‌های موجود، تغییر شناسه‌های سرویس استقرار.
*   **`.github/workflows/<project_name>.yml`**: 
    *   **هدف**: تعریف Workflow CI/CD برای یک پروژه خاص در GitHub Actions.
    *   **تغییرات رایج**: تغییر تریگرهای Workflow، اضافه کردن مراحل جدید (مانند تایید دستی اضافی)، به‌روزرسانی متغیرهای محیطی، یا تغییر مجوزهای Job.

## 3. افزودن یک پروژه جدید به مونوریپو

برای افزودن یک پروژه جدید (مثلاً `new_app`) به مونوریپو و ادغام آن در سیستم CI/CD، مراحل زیر را دنبال کنید:

1.  **ایجاد پوشه پروژه**: پوشه پروژه جدید را در `aladdin-sandbox/apps/new_app` ایجاد کنید.
2.  **اضافه کردن کد و وابستگی‌ها**: کد پروژه و فایل‌های وابستگی (مانند `requirements.txt` برای پایتون یا `package.json` برای Node.js) را در این پوشه قرار دهید.
3.  **به‌روزرسانی `config/projects.yaml`**: یک ورودی جدید برای `new_app` در `config/projects.yaml` اضافه کنید:
    ```yaml
      - name: new_app
        path: apps/new_app
        build: "<دستور بیلد پروژه جدید>"
        test: "<دستور تست پروژه جدید>"
        deploy:
          - environment: Test
            render_service_id: "new-app-test-service-id"
          - environment: Staging
            render_service_id: "new-app-staging-service-id"
          - environment: Production
            render_service_id: "new-app-production-service-id"
    ```
    *   `build`: دستور shell برای ساخت پروژه (مثلاً `pip install -r requirements.txt && python setup.py build`).
    *   `test`: دستور shell برای اجرای تست‌های پروژه (مثلاً `pytest` یا `npm test`).
    *   `render_service_id`: شناسه‌های سرویس Render.com برای هر محیط. این شناسه‌ها باید از قبل در Render.com ایجاد شده باشند.
4.  **ایجاد GitHub Actions Workflow**: یک فایل Workflow جدید در `aladdin-sandbox/.github/workflows/new_app.yml` ایجاد کنید. می‌توانید از Workflowهای موجود به عنوان الگو استفاده کنید. مطمئن شوید که:
    *   `name` Workflow را به `New App CI/CD` تغییر دهید.
    *   `on: push: paths:` را به `apps/new_app/**` تنظیم کنید تا Workflow فقط با تغییرات در این پروژه فعال شود.
    *   پارامتر `--project` در فراخوانی `mamos_runner.py` را به `new_app` تنظیم کنید.
    *   محیط‌های استقرار (`Test`, `Staging`, `Production`) و تاییدهای دستی را به درستی پیکربندی کنید.
5.  **تست**: تغییرات خود را به یک شاخه جدید `push` کنید و Workflow جدید را به صورت دستی اجرا کنید تا از صحت عملکرد آن اطمینان حاصل کنید.

## 4. تغییر Workflowهای موجود

برای تغییر یک Workflow موجود (مثلاً `backend.yml`):

1.  **فایل Workflow را ویرایش کنید**: فایل `aladdin-sandbox/.github/workflows/backend.yml` را باز کنید.
2.  **تغییرات مورد نظر را اعمال کنید**: 
    *   **اضافه کردن مرحله جدید**: می‌توانید یک `step` جدید به Jobهای موجود اضافه کنید (مثلاً برای اجرای یک اسکن امنیتی یا یک تحلیل کیفیت کد).
    *   **تغییر تریگرها**: اگر می‌خواهید Workflow در شرایط دیگری فعال شود، بخش `on:` را تغییر دهید.
    *   **به‌روزرسانی متغیرهای محیطی**: متغیرهای محیطی جدید را اضافه یا موجود را تغییر دهید.
    *   **تغییر مجوزها**: اگر Job جدیدی اضافه می‌کنید که نیاز به مجوزهای بیشتری دارد، بلاک `permissions` را به‌روزرسانی کنید.
3.  **تست**: تغییرات را در یک شاخه جدید `push` کرده و Workflow را به صورت دستی اجرا کنید تا از عملکرد صحیح آن اطمینان حاصل کنید.

## 5. توسعه `mamos_runner.py`

اگر نیاز به تغییر منطق اصلی CI/CD دارید، باید `mamos_runner.py` را ویرایش کنید:

1.  **درک ساختار `mamos_runner.py`**: این اسکریپت از `argparse` برای دریافت آرگومان‌ها (مانند `--project`, `--deploy-env`) استفاده می‌کند. منطق اصلی در توابعی مانند `run_build`, `run_test`, `run_deploy` و `main` قرار دارد.
2.  **اعمال تغییرات**: 
    *   **افزودن نوع پروژه جدید**: اگر می‌خواهید از یک نوع پروژه جدید (مثلاً Go یا Java) پشتیبانی کنید، ممکن است نیاز به افزودن منطق جدید در توابع `run_build` و `run_test` برای اجرای دستورات مربوط به آن زبان باشد.
    *   **بهبود گزارش‌دهی**: می‌توانید فرمت گزارش‌ها را تغییر دهید یا اطلاعات بیشتری را در آن‌ها بگنجانید.
    *   **ادغام با ابزارهای جدید**: اگر می‌خواهید سیستم CI/CD با یک ابزار جدید (مانند یک ابزار تحلیل استاتیک کد یا یک پلتفرم استقرار دیگر) ادغام شود، باید منطق فراخوانی API یا دستورات shell مربوط به آن ابزار را در `mamos_runner.py` اضافه کنید.
3.  **تست**: پس از اعمال تغییرات، `mamos_runner.py` را به صورت محلی با پارامترهای مختلف تست کنید. سپس تغییرات را به یک شاخه جدید `push` کرده و Workflowهای GitHub Actions را اجرا کنید تا از عدم ایجاد رگرسیون اطمینان حاصل کنید.

## 6. مدیریت Secrets و متغیرهای محیطی

*   **افزودن Secrets جدید**: اگر پروژه جدیدی نیاز به یک Secret جدید دارد (مثلاً `NEW_API_KEY`)، آن را به عنوان یک Secret در تنظیمات مخزن GitHub اضافه کنید (`Settings > Secrets and variables > Actions > New repository secret`).
*   **استفاده از Secrets در Workflow**: در فایل Workflow مربوطه، Secret جدید را به عنوان یک متغیر محیطی به Job یا Step مورد نظر تزریق کنید:
    ```yaml
    env:
      NEW_API_KEY: ${{ secrets.NEW_API_KEY }}
    ```
*   **متغیرهای محیطی خاص محیط**: برای متغیرهایی که فقط در یک محیط خاص (مانند `Staging` یا `Production`) معتبر هستند، می‌توانید آن‌ها را در تنظیمات محیط GitHub Actions تعریف کنید (`Settings > Environments > <Environment Name> > Environment secrets`).

## 7. بهترین شیوه‌ها برای توسعه

*   **تغییرات کوچک و مکرر**: تغییرات را در قطعات کوچک انجام دهید و به طور مکرر `commit` و `push` کنید.
*   **تست قبل از ادغام**: همیشه تغییرات خود را در یک شاخه جداگانه تست کنید و قبل از ادغام در `main`، از صحت عملکرد آن‌ها اطمینان حاصل کنید.
*   **بازبینی کد (Code Review)**: تغییرات در `mamos_runner.py` و Workflowهای GitHub Actions باید توسط همکاران بازبینی شوند.
*   **مستندسازی**: هرگونه تغییر مهم در سیستم CI/CD را در مستندات مربوطه ثبت کنید.
*   **استفاده از `workflow_dispatch`**: برای تست تغییرات در Workflowها، از `workflow_dispatch` برای اجرای دستی استفاده کنید تا از فعال شدن ناخواسته Workflowها جلوگیری شود.

## 8. پشتیبانی

در صورت بروز مشکلات پیچیده یا نیاز به کمک تخصصی، با تیم پشتیبانی یا متخصصان CI/CD مشورت کنید.
